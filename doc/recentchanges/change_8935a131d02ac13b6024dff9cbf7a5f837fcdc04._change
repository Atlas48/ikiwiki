[[!meta author="""http://smcv.pseudorandom.co.uk/"""]]

[[!meta authorurl="""http://smcv.pseudorandom.co.uk/"""]]

[[!meta title="""change to todo/want_to_avoid_ikiwiki_using_http_or_https_in_urls_to_allow_serving_both on ikiwiki"""]]

[[!meta permalink="http://ikiwiki.info/recentchanges/#change-8935a131d02ac13b6024dff9cbf7a5f837fcdc04"]]

<div id="change-8935a131d02ac13b6024dff9cbf7a5f837fcdc04" class="metadata">
<span class="desc"><br />Changed pages:</span>
<span class="pagelinks">

<a href="http://git.ikiwiki.info/?p=ikiwiki;a=blobdiff;f=doc/todo/want_to_avoid_ikiwiki_using_http_or_https_in_urls_to_allow_serving_both.mdwn;h=8b0501041379278330dbdb52c3232dc26fef5d2c;hp=f8ec4c420469f47168ced54b93dbe75fa39dfdab;hb=8935a131d02ac13b6024dff9cbf7a5f837fcdc04;hpb=1968317cacc2f555af17286acf26a60ce616cc40" title="diff" rel="nofollow">[[diff|wikiicons/diff.png]]</a><a href="http://ikiwiki.info/ikiwiki.cgi?page=todo%2Fwant_to_avoid_ikiwiki_using_http_or_https_in_urls_to_allow_serving_both&amp;do=goto" rel="nofollow">todo/want to avoid ikiwiki using http or https in urls to allow serving both</a>


</span>
<span class="desc"><br />Changed by:</span>
<span class="committer">

<a href="http://smcv.pseudorandom.co.uk/" rel="nofollow">smcv</a>

</span>
<span class="desc"><br />Commit type:</span>
<span class="committype">web</span>
<span class="desc"><br />Date:</span>
<span class="changedate"><span class="relativedate" title="Tue, 23 Nov 2010 00:37:28 +0000">00:37:28 11/23/10</span></span>
<span class="desc"><br /></span>
</div>

<span class="revert">
<a href="http://ikiwiki.info/ikiwiki.cgi?rev=8935a131d02ac13b6024dff9cbf7a5f837fcdc04&amp;do=revert" title="revert" rel="nofollow">[[revert|wikiicons/revert.png]]</a>
</span>

<div class="changelog">


updated branch, not tested properly yet<br />


</div>

<div class="diff">
<pre>
diff --git a/doc/todo/want_to_avoid_ikiwiki_using_http_or_https_in_urls_to_allow_serving_both.mdwn b/doc/todo/want_to_avoid_ikiwiki_using_http_or_https_in_urls_to_allow_serving_both.mdwn
index f8ec4c4..8b05010 100644
--- a/doc/todo/want_to_avoid_ikiwiki_using_http_or_https_in_urls_to_allow_serving_both.mdwn
+++ b/doc/todo/want_to_avoid_ikiwiki_using_http_or_https_in_urls_to_allow_serving_both.mdwn
@@ -147,7 +147,7 @@ you don&#39;t like my approach:
 
 ----
 
-&#91;&#91;!template id=gitbranch branch=smcv/ready/localurl author=&quot;&#91;&#91;smcv&#93;&#93;&quot;&#93;&#93;
+&#91;&#91;!template id=gitbranch branch=smcv/localurl author=&quot;&#91;&#91;smcv&#93;&#93;&quot;&#93;&#93;
 &#91;&#91;!tag patch&#93;&#93;
 
 OK, here&#39;s an alternative approach, closer in spirit to what was initially
@@ -165,14 +165,17 @@ whether `url` and `cgiurl` are on the same server with the the same URL
 scheme. In theory you could use things like `//static.example.com/wiki/`
 and `//dynamic.example.com/ikiwiki.cgi` to preserve choice of http/https
 while switching server, but I don&#39;t know how consistently browsers
-suppot that.
+support that.
 
 &quot;local&quot; here is short for &quot;locally valid&quot;, because these URLs are neither
 fully relative nor fully absolute, and there doesn&#39;t seem to be a good name
 for them...
 
-I&#39;ve tested this on a demo website with the CGI enabled, and it seems to
+I tested an earlier version on a demo website with the CGI enabled, and it seemed to
 work nicely (there might be bugs in some plugins, I didn&#39;t try all of them).
+I haven&#39;t yet re-tested with my updated branch, which is why it&#39;s not `ready/`
+yet.
+
 The `$config{url}` and `$config{cgiurl}` are both HTTP, but if I enable
 `httpauth`, set `cgiauthurl` to a HTTPS version of the same site and log
 in via that, links all end up in the HTTPS version.
@@ -217,11 +220,19 @@ New API added by this branch:
   &gt;&gt; 
   &gt;&gt;&gt; That makes a great deal of sense, bravo for actually removing
   &gt;&gt;&gt; parameters in the common case while maintaining backwards
-  &gt;&gt;&gt; compatability!
+  &gt;&gt;&gt; compatability! --&#91;&#91;Joey&#93;&#93;
+  &gt;&gt;&gt;
+  &gt;&gt;&gt;&gt; Done in my `localurl` branch; not tested in a whole-wiki way
+  &gt;&gt;&gt;&gt; yet, but I did add a regression test. I&#39;ve used
+  &gt;&gt;&gt;&gt; `urlto(x, undef)` rather than `urlto(x)` so far, but I could
+  &gt;&gt;&gt;&gt; go back through the codebase using the short form if you&#39;d
+  &gt;&gt;&gt;&gt; prefer. --&#91;&#91;smcv&#93;&#93;
   &gt;&gt;&gt; 
   &gt;&gt;&gt; It does highlight that it would be better to have a
   &gt;&gt;&gt; `absolute_urlto($link)` (or maybe `absolute(urlto($link))` )
   &gt;&gt;&gt; rather than the 3 parameter form. --&#91;&#91;Joey&#93;&#93;
+  &gt;&gt;&gt;
+  &gt;&gt;&gt; Possibly. I haven&#39;t added this.
 
 * `IkiWiki::baseurl` has a new second argument which works like the
   third argument of `urlto`
@@ -232,19 +243,34 @@ New API added by this branch:
   &gt;&gt; (But I assume changes to `urlto` will follow through here anyway.)
   &gt;&gt; --&#91;&#91;Joey&#93;&#93; 
 
+  &gt;&gt;&gt; I had to use it a bit more, as a replacement for `$config{url}`
+  &gt;&gt;&gt; when doing things like referencing stylesheets or redirecting to
+  &gt;&gt;&gt; the top of the wiki.
+  &gt;&gt;&gt;
+  &gt;&gt;&gt; I ended up redoing this without the extra parameter. Previously,
+  &gt;&gt;&gt; `baseurl(undef)` was the absolute URL; now, `baseurl(undef)` is
+  &gt;&gt;&gt; the local path. I know you objected to me using `baseurl()` in
+  &gt;&gt;&gt; an earlier branch, because `baseurl().$x` looks confusingly
+  &gt;&gt;&gt; similar to `baseurl($x)` but has totally different semantics;
+  &gt;&gt;&gt; I&#39;ve generally written it `baseurl(undef)` now, to be more
+  &gt;&gt;&gt; explicit. --&#91;&#91;smcv&#93;&#93;
+
 * `IkiWiki::cgiurl` uses `$local_cgiurl` if passed `local_cgiurl =&gt; 1`
 
-  &gt; Possibly changed to making this always be local unless `cgiurl =&gt; $x`
-  &gt; is given: see below --&#91;&#91;smcv&#93;&#93;
+  &gt; Now changed to always use the `$local_cgiurl`. --&#91;&#91;smcv&#93;&#93;
 
 * `IkiWiki::cgiurl` omits the trailing `?` if given no named parameters
   except `cgiurl` and/or `local_cgiurl`
 
   &gt; I assume you have no objection to this --&#91;&#91;smcv&#93;&#93;
   &gt; 
-  &gt;&gt; Nod, although I don&#39;t know of a use case. --&#91;&#91;Joey&#93;&#93; 
+  &gt;&gt; Nod, although I don&#39;t know of a use case. --&#91;&#91;Joey&#93;&#93;
+
+  &gt;&gt;&gt; The use-case is that I can replace `$config{cgiurl}` with
+  &gt;&gt;&gt; `IkiWiki::cgiurl()` for things like the action attribute of
+  &gt;&gt;&gt; forms. --&#91;&#91;smcv&#93;&#93;
 
-Bugs:
+Fixed bugs:
 
 * I don&#39;t think anything except `openid` calls `cgiurl` without also
   passing in `local_cgiurl =&gt; 1`, so perhaps that should be the default;
@@ -265,6 +291,10 @@ Bugs:
   &gt;&gt;&gt; if `absolute()` were implemented as suggested above, it could also
   &gt;&gt;&gt; be used with cgiurl if necessary.) --&#91;&#91;Joey&#93;&#93;
 
+  &gt;&gt;&gt;&gt; Done (minus `absolute()`). --&#91;&#91;smcv&#93;&#93;
+
+Potential future things:
+
 * It occurs to me that `IkiWiki::cgiurl` could probably benefit from being
   exported? Perhaps also `IkiWiki::baseurl`?
 
@@ -285,4 +315,7 @@ Bugs:
   &gt; AFACIS, `baseurl` is only called in 3 places so I don&#39;t think that&#39;s
   &gt; needed. --&#91;&#91;Joey&#93;&#93; 
 
-  &gt;&gt; OK, wontfix. --&#91;&#91;smcv&#93;&#93;
+  &gt;&gt; OK, wontfix. For what it&#39;s worth, my branch has 6 uses in IkiWiki
+  &gt;&gt; core code (IkiWiki, CGI, Render and the pseudo-core part of editpage)
+  &gt;&gt; and 5 in plugins, since I used it for things like redirection back
+  &gt;&gt; to the top of the wiki --&#91;&#91;smcv&#93;&#93;

</pre>
</div>

<!-- 8935a131d02ac13b6024dff9cbf7a5f837fcdc04 -->
