Instead of having files foo.html "in front of" foo/, I prefer to have foo/index.html. This patch allows that. Specifically, foo/index.type is translated to $links{'foo/'}, and bestlink looks for either "foo" or "foo/" when linking to pages. There are other miscellaneous changes that go with that:

1. backlinks from "foo/bar" to "foo/" trim common prefixes as long as there would be something left when the trimming is done (i.e. don't trim "foo/")
2. parentlinks for "foo/" are the same as for "foo", except one directory higher
3. rewrite parentlinks so that bestlink is called at each level
4. basename("foo/") => basename("foo")
5. links to "foo/" are translated to "foo/index.html" rather than "foo/.html". (Links to "foo/" might be preferred, but that causes an infinite loop in writefile, because apparently dirname("foo/") == "foo/" on my system for reasons that aren't clear to me.)
6. pagetitle("foo/") => pagetitle("foo")

In case whitespace gets garbled, I'm also leaving a copy of the patch on [my site](http://ikidev.betacantrips.com/patches/index.patch). It should apply cleanly to a freshly unpacked ikiwiki-1.40. You can also see it in action [here](http://ikidev.betacantrips.com/one/). --Ethan

    diff -urx .svn ikiwiki/IkiWiki/Render.pm ikidev/IkiWiki/Render.pm
    --- ikiwiki/IkiWiki/Render.pm	2007-01-11 15:01:51.000000000 -0800
    +++ ikidev/IkiWiki/Render.pm	2007-01-15 18:38:34.000000000 -0800
    @@ -40,6 +40,7 @@
     		my $dir;
     		1 while (($dir)=$page_trimmed=~m!^([^/]+/)!) &&
     		        defined $dir &&
    +			$p_trimmed=~m/^\Q$dir\E(?:.)/ &&
     		        $p_trimmed=~s/^\Q$dir\E// &&
     		        $page_trimmed=~s/^\Q$dir\E//;
     			       
    @@ -57,10 +58,18 @@
     	my $path="";
     	my $skip=1;
     	return if $page eq 'index'; # toplevel
    -	foreach my $dir (reverse split("/", $page)) {
    +	if ($page =~ m{/$}){
    +		$page =~ s{/$}{};
    +		$path="../";
    +	}
    +
    +	while ($page =~ m!([^/]+)$!) {
    +		my $last = $1;
    +		$page =~ s!/?[^/]+$!!;
     		if (! $skip) {
     			$path.="../";
    -			unshift @ret, { url => $path.htmlpage($dir), page => pagetitle($dir) };
    +			my $target = abs2rel(htmlpage(bestlink($page, $last)), $page);
    +			unshift @ret, { url => $path.$target, page => pagetitle($last) };
     		}
     		else {
     			$skip=0;
    diff -urx .svn ikiwiki/IkiWiki.pm ikidev/IkiWiki.pm
    --- ikiwiki/IkiWiki.pm	2007-01-12 12:47:09.000000000 -0800
    +++ ikidev/IkiWiki.pm	2007-01-15 16:56:58.000000000 -0800
    @@ -185,6 +185,7 @@
     sub basename ($) { #{{{
     	my $file=shift;
     
    +	$file=~s!/$!!;
     	$file=~s!.*/+!!;
     	return $file;
     } #}}}
    @@ -211,12 +212,14 @@
     	my $type=pagetype($file);
     	my $page=$file;
     	$page=~s/\Q.$type\E*$// if defined $type;
    +	$page=~s#index$## if $page=~m{/index$};
     	return $page;
     } #}}}
     
     sub htmlpage ($) { #{{{
     	my $page=shift;
     
    +	return $page."index.html" if $page=~m{/$};
     	return $page.".html";
     } #}}}
     
    @@ -300,6 +303,7 @@
     	my $page=shift;
     	my $link=shift;
     	
    +	$page =~ s!/$!!;
     	my $cwd=$page;
     	if ($link=~s/^\/+//) {
     		# absolute links
    @@ -314,6 +318,9 @@
     		if (exists $links{$l}) {
     			return $l;
     		}
    +		if (exists $links{$l.'/'}){
    +			return $l.'/';
    +		}
     		elsif (exists $pagecase{lc $l}) {
     			return $pagecase{lc $l};
     		}
    @@ -344,6 +351,7 @@
     		$page=~s/__(\d+)__/&#$1;/g;
     	}
     	$page=~y/_/ /;
    +	$page=~s!/$!!;
     
     	return $page;
     } #}}}
